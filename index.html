<!DOCTYPE html>
<html>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="/js/filter.js"></script>
<script src="/js/blooming-menu.min.js"></script>
<script src="/js/jsplumb.js "></script>


<head>


    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Trirong:100,200" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/buttons.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/open-iconic-bootstrap.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/search.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/styles.css" media="screen,projection">

</head>

<body>


    <script>

        var searchIndex;
        var menu = new BloomingMenu({
            itemsNum: 2,
            radius: 30,
            startAngle: 0,
            endAngle: 180
        });
        menu.render();


        var menuNode = d3.selectAll(".blooming-menu__container");

        menuNode.style("z-index", "3");
        menuNode
            .on("click", function () {
                menu.close();
                setTimeout(function () { menuNode.style("display", "none"); }, 400);
            });



        $.getJSON("/database/search_index.json", function (json) {
            searchIndex = json;;
        });

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");
        var providers = [];
        var catColumns = [];
        var categories = [];
        var services = [];
        var data;
        var zoomFactor = 1.0;
        var imgMinSize = 20;
        var iconScale = imgMinSize * zoomFactor;
        var fontSize = imgMinSize / 2;
        var leftHeaderPositions;
        var leftContainer;
        var providerColumn;
        var currentElementId = null;
        var landscape;


        var lastSelectedItemPos = { "x": null, "y": null };

        const zoomMin = 0.8;
        const zoomMax = 3.0;

        // Read database
        d3.json("./database/cloud_services_nested_mc.json", function (d) {
            data = d;
            createLandscape(d);
        });

        /*
        * createLandscape creates the main grid in the right layout div based on the data from json file
        * IMPORTANT NOTES:
        * - The grid technically consists of ONLY ONE ROW to enable automatical wraping provided by the bootstrap lib 
        * - Every column consists of further rows. The amount of these rows depends on the amount of key1-categories (in this example: providers)
        *   The height of theses rows must be normalized manually to provide the table like appearance. This can be done with the normalizeHeight function.
        * - The very left column with the key1-category names (= providers) is technically not a part of the main grid. 
        *   It is detached to an extra column. This is done to keep it on the very left while cloning it along with the main grid wraps.
        */

        function createLandscape(d) {


            landscape = d3.selectAll("body")
                .append("div")
                .attr("class", "container-fluid")
                .attr("id", "landscape")
                .append("div")
                .attr("class", "row master");

            var arrowLayer = d3.selectAll("body")
                .append("div")
                .attr("class", "svgContainer")
                .attr("id", "svgContainer")
                .append("svg")
                .attr("id", "arrowlayer")
                .attr("height", "100%")
                .attr("width", "100%")
                .style("position", "absolute");

            leftContainer = landscape
                .append("div")
                .attr("class", "col-md-auto")
                .attr("id", "leftContainer")
                .style("width", "100px");

            var rightContainer = landscape
                .append("div")
                .attr("class", "col-sm")


            var grid = rightContainer
                .append("div")
                .attr("class", "row master");


            data[0].categories.forEach(d => {
                var column = grid
                    .append("div")
                    .attr("class", "col header")
                    .attr("id", "catColumn");

                catColumns.push(column);
                column
                    .append("div")
                    .attr("class", "row")
                    .attr("id", "hHeader")
                    .text(d.category);
            });

            data.forEach(d => {

                var cc = 0;
                var id_index = 0;

                catColumns.forEach(c => {
                    var cat = c
                        .append("div")
                        .attr("class", "row")
                        .append("div")
                        .attr("class", "categories")
                        .attr("id", "cContainer");
                    categories.push(cat);
                    d.categories[cc].members.forEach(m => {
                        var service = cat.append("div")
                            .attr("class", "serviceIcon")
                            .attr("id", m.id)
                            .append("img")
                            .attr("src", m.img)
                            .attr("height", imgMinSize)
                            .attr("width", imgMinSize);

                        services.push(service);
                        service
                            .on("mousemove", function () {
                                tooltip
                                    .style("left", d3.event.pageX - 50 + "px")
                                    .style("top", d3.event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    .text(m.service);
                            })
                            .on("mouseout", function (d, i) {
                                tooltip.style("display", "none");
                            })
                            .on("click", function () {
                                currentElementId = m.id;
                                processItemClick(this);
                            });

                    });
                    cc++;
                });

            });

            unlockResizing();
            updateLefHandHeader();
            lockResizing();

            jsPlumb.bind("ready", function () {

            });
            jsPlumb.importDefaults({
                Endpoint: "Blank",
                Container: "svgContainer",
                Connector: ["Bezier", { curviness: 0 }],
                Anchors: ["Top", "Bottom", "Left", "Right"],


            });


            //jsPlumb.setContainer("svgContainer");
        }

        /*
        * unlockResizing sets the width and height parameters of grid columns to auto 
        * so they automatically adjust to the size of their content without further calculations
        */
        function unlockResizing() {
            d3.selectAll("#cContainer").style("height", "auto");
            d3.selectAll("#vHeader").style("height", "auto");
            d3.selectAll("#hHeader").style("height", "auto");

            d3.selectAll("#cContainer").style("width", "auto");
            d3.selectAll("#vHeader").style("width", "auto");
            d3.selectAll("#hHeader").style("width", "auto");
        }

        /*
        * lockResizing normalizes the height of grid elements. This is very important to keep the height
        * of all rows at the same value
        */
        function lockResizing() {
            normalizeHeight("#cContainer", "#cContainer");
            normalizeHeight("#cContainer", "#vHeader", 2);
            normalizeHeight("#hHeader", "#hHeader");
        }

        function updateLefHandHeader() {
            leftHeaderPositions = distinctYPos("#catColumn");
            var c = 1;
            document.getElementById("leftContainer").innerHTML = '';
            d3.selectAll("#providerColumn").remove();
            leftHeaderPositions.forEach(p => {
                var pos = (p - 1) / c;
                pos = 10;
                providerColumn = leftContainer
                    .append("div")
                    .attr("class", "col header")
                    .attr("id", "providerColumn")
                    .style("margin-top", pos + "px");


                providerColumn
                    .append("div")
                    .attr("class", "row")
                    .attr("id", "hHeader");

                data.forEach(d => {

                    var providerName = providerColumn
                        .append("div")
                        .attr("class", "row")
                        .attr("id", "vHeader")
                        .style("font-size", fontSize)
                        .datum(d)
                        .text(d.provider);
                    providers.push(providerName);
                });
                c++;
            });

        }

        /**
        * normalizeHeight finds the max height of the elements
        * in the source group and applies it to all elements in the target group
        * @Params:
        *   sID: id of the elements in the source group
        *   tID: id of the elements in the target group
        *   padding: can be added as an offset to the max height h
        */
        function normalizeHeight(sID, tID, padding) {

            padding = padding || 0;

            var source = d3.selectAll(sID);
            var target = d3.selectAll(tID);
            var h = 0;
            source._groups[0].forEach(function (g) {
                _h = g.clientHeight;

                if (_h > h) {
                    h = _h;
                }
            })

            d3.selectAll(tID).style("height", h + padding + "px");
        }

        /*
        * zoom changes the size of images and text in the grid larger or smaller
        * and adjusts the size of the parent elements if necessary
        */
        function zoom(scale) {
            menu.close();

            zoomFactor = zoomFactor + scale;

            // keep zoom factor between zoomMin and zoomMax
            zoomFactor = Math.min(Math.max(zoomFactor, zoomMin), zoomMax);
            iconScale = imgMinSize * zoomFactor;
            unlockResizing();

            var images = d3.selectAll("img");
            images
                .attr("height", iconScale + "px");
            images
                .attr("width", iconScale + "px");

            var iconContainers = d3.selectAll(".serviceIcon");
            iconContainers
                .style("height", iconScale + "px");
            iconContainers
                .style("width", iconScale + "px");

            d3.selectAll(".categories")
                .style("grid-template-rows", "repeat(4," + iconScale + "px)");

            d3.selectAll("#hHeader").style("font-size", fontSize * zoomFactor + "px");
            d3.selectAll("#vHeader").style("font-size", fontSize * zoomFactor + "px");

            d3.selectAll("#zoomIndicator").text("ZOOM: " + Math.floor(zoomFactor * 100) + "%");
            updateLefHandHeader();
            lockResizing();
            jsPlumb.repaintEverything();
            adjustSVGOverlay();
            jsPlumb.repaintEverything();
            //showDependencies();
        }


        /**
        * resets image and text size inside the grid
        */
        function zoomReset() {

            zoomFactor = 1.0;
            zoom(0);

        }

        /**
        * distinctYPos returns a list of y-positions of all elements with the given id
        * the returned list only contains distinct values, redundand values are removed
        */
        function distinctYPos(id) {
            var elements = d3.selectAll(id)._groups[0];
            var cYPositions = new Set();
            elements.forEach(el => {
                cYPositions.add(posY(el));

            })

            var result = [...cYPositions];
            return result;
        }

        function posY(el) {
            for (var ly = 0; el != null; ly += el.offsetTop, el = el.offsetParent);
            return ly;
        }

        function posX(el) {
            for (var lx = 0; el != null; lx += el.offsetLeft, el = el.offsetParent);
            return lx;
        }


        function adjustContainers() {
            unlockResizing();
            updateLefHandHeader();
            lockResizing();
            jsPlumb.repaintEverything();
            adjustSVGOverlay();
            jsPlumb.repaintEverything();
            //showDependencies();

        }

        function adjustSVGOverlay() {
            var svgContainer = document.getElementById("svgContainer");
            var parentContainer = document.getElementById("landscape");
            svgContainer.style.width = parentContainer.clientWidth + "px";
            svgContainer.style.height = parentContainer.clientHeight + "px";
        }

        function processItemClick(node) {

            menuNode.style("display", "inline-block");

            var x = posX(node) + iconScale / 2;
            var y = posY(node) + iconScale / 2;


            if (!((lastSelectedItemPos.x == x) && (lastSelectedItemPos.y == y))) {
                lastSelectedItemPos.x = x;
                lastSelectedItemPos.y = y;
                menu.close();

                menu.setPos(x, y);
            }

            if (menu.isOpen()) {
                menu.close();
            } else {
                menu.open();
            }

        }


        d3.select("#menu_button_0").on("click", showDependenciesPlumb);


        window.addEventListener("resize", adjustContainers);
        /**
         * "If you are writing code and you are not sure of the data you are using there is something wrong in the design of the whole project."
         * -- Blindman67
         * https://stackoverflow.com/questions/42252538/deep-search-json-object
         */






    </script>

    <div class="sidenav">
        <div class="toolbox">
            <!-- Search design based on https://bootsnipp.com/snippets/exqd3 by Siddharth Panchal -->
            <form id="form">
                <input id="form-tags-1" name="tags-1" type="text">
            </form>
            <button class="button button-primary button-rectangel" onclick="search()" type="button"><span class="oi oi-magnifying-glass"></span></button>
        </div>
        <div class="toolbox">
            <p id="zoomIndicator">ZOOM: 100%</p>

            <button class="button button-primary button-circle" onclick="zoom(0.1)"><span class="oi oi-zoom-in"></span></button>
            <button class="button button-primary button-circle" onclick="zoom(-0.1)"><span class="oi oi-zoom-out"></button>
            <button class="button button-primary button-circle" onclick="zoomReset()"><span class="oi oi-fullscreen-enter"></button>
        </div>


    </div>



</body>


</html>