<!DOCTYPE html>
<html>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="/js/filter.js"></script>
<script src="/js/blooming-menu.min.js"></script>
<script src="/js/jsplumb.js "></script>
<script src="/js/utilities.js "></script>


<head>


    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Trirong:100,200" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/buttons.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/open-iconic-bootstrap.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/search.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" media="screen,projection">
    <link rel="stylesheet" type="text/css" href="/css/styles.css" media="screen,projection">

</head>

<body>


    <script>

        var searchIndex;
        var menu = new BloomingMenu({
            itemsNum: 2,
            radius: 30,
            startAngle: 0,
            endAngle: 180
        });
        menu.render();


        var menuNode = d3.selectAll(".blooming-menu__container");

        menuNode.style("z-index", "3");
        menuNode
            .on("click", function () {
                menuCloseAdapter();
            });



        $.getJSON("/database/search_index.json", function (json) {
            searchIndex = json;;
        });

        var tooltip = d3.select("body").append("div").attr("class", "toolTip");
        var catColumns = [];
        var categories = [];
        var data;
        var zoomFactor = 1.0;
        var imgMinSize = 20;
        var iconScale = imgMinSize * zoomFactor;
        var fontSize = imgMinSize / 2;
        var leftHeaderPositions;
        var leftContainer;
        var providerColumn;
        var currentElementId = null;
        var landscape;



        var lastSelectedItemPos = { "x": null, "y": null };

        const zoomMin = 0.8;
        const zoomMax = 3.0;

        // Read database
        d3.json("./database/cloud_services_nested_mc.json", function (d) {
            data = d;
            createLandscape(d);
        });

        /*
        * createLandscape creates the main grid in the right layout div based on the data from json file
        * IMPORTANT NOTES:
        * - The grid technically consists of ONLY ONE ROW to enable automatical wraping provided by the bootstrap lib 
        * - Every column consists of further rows. The amount of these rows depends on the amount of key1-categories (in this example: providers)
        *   The height of theses rows must be normalized manually to provide the table like appearance. This can be done with the normalizeHeight function.
        * - The very left column with the key1-category names (= providers) is technically not a part of the main grid. 
        *   It is detached to an extra column. This is done to keep it on the very left while cloning it along with the main grid wraps.
        */

        function createLandscape(d) {


            landscape = d3.select("body")
                .append("div")
                .attr("class", "container-fluid")
                .attr("id", "landscape")
                .append("div")
                .attr("class", "row master");

            d3.select("body").append("div").attr("id", "overlay");

            var arrowLayer = d3.selectAll("body")
                .append("div")
                .attr("class", "svgContainer")
                .attr("id", "svgContainer")
                .append("svg")
                .attr("id", "arrowlayer")
                .attr("height", "100%")
                .attr("width", "100%")
                .style("position", "absolute");

            leftContainer = landscape
                .append("div")
                .attr("class", "col-md-auto")
                .attr("id", "leftContainer")
                .style("width", "100px");

            var rightContainer = landscape
                .append("div")
                .attr("class", "col-sm")


            var grid = rightContainer
                .append("div")
                .attr("class", "row master");


            data[0].categories.forEach(d => {
                var column = grid
                    .append("div")
                    .attr("class", "col header")
                    .attr("id", "catColumn");

                catColumns.push(column);

                column
                    .append("div")
                    .attr("class", "row")
                    .attr("id", "hHeader")
                    .text(d.category);
            });

            data.forEach(d => {

                var cc = 0;
                var id_index = 0;

                catColumns.forEach(c => {
                    var cat = c
                        .append("div")
                        .attr("class", "row")
                        .append("div")
                        .attr("class", "categories")
                        .attr("id", "cContainer");
                    categories.push(cat);
                    d.categories[cc].members.forEach(m => {
                        var service = cat.append("div")
                            .attr("class", "serviceIcon")
                            .attr("id", m.id)
                            .append("img")
                            .attr("src", m.img)
                            .attr("height", imgMinSize)
                            .attr("width", imgMinSize);
                        service
                            .on("mousemove", function () {
                                tooltip
                                    .style("left", d3.event.pageX - 50 + "px")
                                    .style("top", d3.event.pageY - 70 + "px")
                                    .style("display", "inline-block")
                                    .text(m.service);
                            })
                            .on("mouseout", function (d, i) {
                                tooltip.style("display", "none");
                            })
                            .on("click", function () {
                                currentElementId = m.id;
                                processItemClick(this);
                            });

                    });
                    cc++;
                });


            });

            unlockResizing();
            updateLefHandHeader();
            lockResizing();

            jsPlumb.bind("ready", function () {

            });
            jsPlumb.importDefaults({
                Endpoint: "Blank",
                Container: "svgContainer",
                Anchors: ["Top", "Bottom", "Left", "Right"],

            });

        }

        createDetailsView();



        d3.select("#menu_button_0").on("click", showDependenciesPlumb);
        d3.select("#menu_button_1").on("click", showDetails);


        window.addEventListener("resize", adjustContainers);

        d3.select("body")
            .on("keydown", function () {
                if (d3.event.key == "Escape") {
                    resetView();
                }
            })


        /**
         * "If you are writing code and you are not sure of the data you are using there is something wrong in the design of the whole project."
         * -- Blindman67
         * https://stackoverflow.com/questions/42252538/deep-search-json-object
         */


    </script>

    <div class="sidenav">
        <div class="toolbox">
            <!-- Search design based on https://bootsnipp.com/snippets/exqd3 by Siddharth Panchal -->
            <form id="form">
                <input id="form-tags-1" name="tags-1" type="text">
            </form>
            <button class="button button-primary button-rectangel" onclick="search()" type="button"><span class="oi oi-magnifying-glass"></span></button>
        </div>
        <div class="toolbox">
            <p id="zoomIndicator">ZOOM: 100%</p>

            <button class="button button-primary button-circle" onclick="zoom(0.1)"><span class="oi oi-zoom-in"></span></button>
            <button class="button button-primary button-circle" onclick="zoom(-0.1)"><span class="oi oi-zoom-out"></button>
            <button class="button button-primary button-circle" onclick="zoomReset()"><span class="oi oi-fullscreen-enter"></button>
        </div>

    </div>




</body>


</html>